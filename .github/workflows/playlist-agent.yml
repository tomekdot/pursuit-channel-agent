name: Maniaplanet Playlist Agent
permissions:
  contents: read

on:
  schedule:
    # Daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch: {}

jobs:
  run-agent:
    # This workflow is triggered only by schedule and workflow_dispatch;
    # it does not run on pull_request events, so no runtime pull_request
    # context checks are necessary here.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Avoid passing GITHUB_TOKEN to checked-out actions/commands unless needed
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          # Use a modern Python runtime; 3.11 is recommended for CI
          python-version: '3.11'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Check Chromedriver availability
        id: check
        env:
          CHROMEDRIVER_URL: ${{ secrets.CHROMEDRIVER_URL }}
        run: |
          if [ -n "$CHROMEDRIVER_URL" ]; then
            echo "has_chromedriver=true" >> $GITHUB_OUTPUT
          else
            echo "has_chromedriver=false" >> $GITHUB_OUTPUT
          fi

      - name: "Optional: download & verify Chromedriver"
        if: steps.check.outputs.has_chromedriver == 'true'
        # Accept CHROMEDRIVER_URL and CHROMEDRIVER_SHA256 as repository secrets.
        # If CHROMEDRIVER_URL is not provided, this step is skipped.
        env:
          CHROMEDRIVER_URL: ${{ secrets.CHROMEDRIVER_URL }}
          CHROMEDRIVER_SHA256: ${{ secrets.CHROMEDRIVER_SHA256 }}
        run: |
          set -euo pipefail
          tmpfile=$(mktemp)
          echo "Downloading Chromedriver from: $CHROMEDRIVER_URL"
          curl -fsSL "$CHROMEDRIVER_URL" -o "$tmpfile"
          if [ -n "${CHROMEDRIVER_SHA256:-}" ]; then
            echo "Verifying SHA256 checksum..."
            printf "%s  %s\n" "$CHROMEDRIVER_SHA256" "$tmpfile" > checksum.txt
            sha256sum -c checksum.txt
          else
            echo "No CHROMEDRIVER_SHA256 provided; skipping checksum verification."
          fi
          mkdir -p chromedriver
          # Try to unpack zip or tar.gz; fall back to placing the file as-is
          mime="$(file -b --mime-type "$tmpfile" || true)"
          if echo "$mime" | grep -qi zip; then
            unzip -q "$tmpfile" -d chromedriver
          else
            if tar -tzf "$tmpfile" >/dev/null 2>&1; then
              tar -xzf "$tmpfile" -C chromedriver
            else
              # Not an archive we recognize; move into chromedriver dir
              mv "$tmpfile" chromedriver/
            fi
          fi
          # Locate binary and make executable
          driver_path="$(find chromedriver -type f -name 'chromedriver*' -print -quit || true)"
          if [ -z "$driver_path" ]; then
            driver_path="$(find chromedriver -type f -print -quit || true)"
          fi
          if [ -n "$driver_path" ]; then
            chmod +x "$driver_path" || true
            echo "CHROMEDRIVER=$PWD/$driver_path" >> $GITHUB_ENV
            echo "Chromedriver installed at $PWD/$driver_path"
          else
            echo "Could not find chromedriver binary after extraction" >&2
            exit 1
          fi

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Dry-run lunar logic
        # This step exercises the lunar selection logic without performing Selenium actions.
        run: |
          DRY_RUN=1 python -u agent.py

      - name: Run agent (debug)
        env:
          LOGIN: ${{ secrets.MANIAPLANET_LOGIN }}
          PASSWORD: ${{ secrets.MANIAPLANET_PASSWORD }}
          TARGET_URL: ${{ vars.TARGET_URL }}
          LOGIN_URL: ${{ vars.LOGIN_URL }}
          PLAYLIST_IDS: ${{ vars.PLAYLIST_IDS }}
          WAIT_TIMEOUT: 60
          PYTHONUNBUFFERED: 1
        run: |
          python -u agent.py 2>&1 | tee agent.log

      - name: Upload agent logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: agent-log
          path: agent.log
          retention-days: 3
