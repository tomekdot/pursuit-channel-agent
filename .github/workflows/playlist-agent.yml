name: Maniaplanet Playlist Agent
permissions:
  contents: read

on:
  schedule:
    # Daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch: {}

jobs:
  run-agent:
    # This workflow is triggered only by schedule and workflow_dispatch;
    # it does not run on pull_request events, so no runtime pull_request
    # context checks are necessary here.
    runs-on: ubuntu-latest
    # Intentionally keep this job free of repository-level `vars` expressions
    # that can trigger editor schema warnings. Chromedriver provisioning is
    # handled by a separate manual workflow (`chromedriver-provision.yml`).
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Avoid passing GITHUB_TOKEN to checked-out actions/commands unless needed
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          # Use Python 3.14 per request
          python-version: '3.14'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # Chromedriver provisioning is intentionally removed from this main
      # workflow to avoid editor schema warnings about `${{ vars.* }}` usage.
      # Use the `chromedriver-provision` manual workflow to produce a
      # verified artifact when you want to make a chromedriver available.

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Dry-run lunar logic
        # This step exercises the lunar selection logic without performing Selenium actions.
        run: |
          DRY_RUN=1 python -u agent.py

      - name: Check MANIAPLANET secrets
        # Helpful runtime message so logs show why the agent step may be skipped.
        env:
          MANIAPLANET_LOGIN: ${{ secrets.MANIAPLANET_LOGIN }}
          MANIAPLANET_PASSWORD: ${{ secrets.MANIAPLANET_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "$MANIAPLANET_LOGIN" ] || [ -z "$MANIAPLANET_PASSWORD" ]; then
            echo "MANIAPLANET secrets not configured; the agent step will be skipped."
          else
            echo "MANIAPLANET secrets configured; the agent step will run.";
          fi

      - name: Run agent (debug)
        # Only attempt to run the agent if credentials are configured; in
        # scheduled or non-interactive environments we want the workflow to
        # gracefully skip rather than erroring out with missing secrets.
        env:
          LOGIN: ${{ secrets.MANIAPLANET_LOGIN }}
          PASSWORD: ${{ secrets.MANIAPLANET_PASSWORD }}
          TARGET_URL: ${{ vars.TARGET_URL }}
          LOGIN_URL: ${{ vars.LOGIN_URL }}
          PLAYLIST_IDS: ${{ vars.PLAYLIST_IDS }}
          WAIT_TIMEOUT: '60'
          PYTHONUNBUFFERED: '1'
        run: |
          set -euo pipefail
          if [ -z "$LOGIN" ] || [ -z "$PASSWORD" ]; then
            echo "MANIAPLANET login/password secrets not set; skipping agent run."
            exit 0
          fi
          python -u agent.py 2>&1 | tee agent.log

      - name: Upload agent logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: agent-log
          path: agent.log
          retention-days: 3
